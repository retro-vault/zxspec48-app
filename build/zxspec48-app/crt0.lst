                                      1         ;; crt0.s
                                      2         ;; 
                                      3         ;; zx spectrum 48K ram startup code
                                      4         ;;
                                      5         ;; MIT License (see: LICENSE)
                                      6         ;; Copyright (C) 2021 Tomaz Stih
                                      7         ;;
                                      8         ;; 2021-06-16   tstih
                                      9         .module crt0
                                     10         
                                     11         .area   _CODE
                                     12 
    00000000 ED 73r00r00      [20]   13         ld      (#__store_sp),sp        ; store current stack pointer
    00000004 31r02r02         [10]   14         ld      sp,#__stack             ; load new stack pointer
                                     15 
                                     16         ;; store all regs
    00000007 F5               [11]   17         push    af
    00000008 C5               [11]   18         push    bc
    00000009 D5               [11]   19         push    de
    0000000A E5               [11]   20         push    hl
    0000000B DD E5            [15]   21         push    ix
    0000000D FD E5            [15]   22         push    iy
    0000000F 08               [ 4]   23         ex      af, af'
    00000010 F5               [11]   24         push    af
    00000011 D9               [ 4]   25         exx
    00000012 C5               [11]   26         push    bc
    00000013 D5               [11]   27         push    de
    00000014 E5               [11]   28         push    hl
                                     29 
    00000015 CDr00r00         [17]   30         call    gsinit                  ; call SDCC init code
                                     31 
                                     32         ;; call C main function
    00000018 CDr00r00         [17]   33         call    _main			
                                     34 
                                     35         ;; restore all regs
    0000001B E1               [10]   36         pop     hl
    0000001C D1               [10]   37         pop     de
    0000001D C1               [10]   38         pop     bc
    0000001E F1               [10]   39         pop     af
    0000001F D9               [ 4]   40         exx
    00000020 08               [ 4]   41         ex      af,af'
    00000021 FD E1            [14]   42         pop     iy
    00000023 DD E1            [14]   43         pop     ix
    00000025 E1               [10]   44         pop     hl
    00000026 D1               [10]   45         pop     de
    00000027 C1               [10]   46         pop     bc
    00000028 F1               [10]   47         pop     af
                                     48 
    00000029 ED 7Br00r00      [20]   49         ld      sp,(#__store_sp)        ; restore original stack pointer
                                     50 
                                     51         ;; return to wherever you were called from
    0000002D C9               [10]   52         ret	
                                     53 
                                     54         ;;	(linker documentation:) where specific ordering is desired - 
                                     55         ;;	the first linker input file should have the area definitions 
                                     56         ;;	in the desired order
                                     57         .area   _GSINIT
                                     58         .area   _GSFINAL	
                                     59         .area   _HOME
                                     60         .area   _INITIALIZER
                                     61         .area   _INITFINAL
                                     62         .area   _INITIALIZED
                                     63         .area   _DATA
                                     64         .area   _BSS
                                     65         .area   _HEAP
                                     66 
                                     67         ;;	this area contains data initialization code.
                                     68         .area _GSINIT
    00000000                         69 gsinit:	
                                     70         ;; initialize vars from initializer
    00000000 11r00r00         [10]   71         ld      de, #s__INITIALIZED
    00000003 21r00r00         [10]   72         ld      hl, #s__INITIALIZER
    00000006 01r00r00         [10]   73         ld      bc, #l__INITIALIZER
    00000009 78               [ 4]   74         ld      a, b
    0000000A B1               [ 4]   75         or      a, c
    0000000B 28 02            [12]   76         jr      z, gsinit_none
    0000000D ED B0            [21]   77         ldir
    0000000F                         78 gsinit_none:
                                     79         .area _GSFINAL
    00000000 C9               [10]   80         ret
                                     81 
                                     82         .area _DATA
                                     83         .area _BSS
                                     84         ;; this is where we store the stack pointer
    00000000                         85 __store_sp:	
    00000000 01 00                   86         .word 1
                                     87         ;; 512 bytes of stack.
    00000002                         88         .ds	512
    00000202                         89 __stack::
                                     90         .area _HEAP
    00000000                         91 __heap::
